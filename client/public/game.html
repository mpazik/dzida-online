<script src="lib/requirejs/require.js"></script>
<template id="game-element">
    <style>
        :host {
            width: 100%;
            height: 100%;
        }

        #game-state {
            font-size: 44px;
            position: absolute;
            width: 100%;
            text-align: center;
            top: 30%;
            color: #f7d104;
            text-shadow: 0 0 4px #fff;
        }
    </style>
    <div id="game-state"></div>
    <div id="game-render"></div>
</template>
<script>

    (function (doc) {
        require.config({
            shim: {
                'configuration': {
                    exports: 'Configuration'
                }
            },
            paths: {
                "lib/pixi": "lib/pixi.js/bin/pixi",
                "configuration": "src/configuration"
            }
        });

        require(['src/component/application', 'src/store/stats', 'src/component/dispatcher', 'src/component/backdoor', 'src/store/ui-state', 'src/component/timer', 'src/store/skill'
        ], function (App, StatsStore, Dispatcher, Backdoor, UiStateStore, Timer, Skills) {
            const GameTag = Object.create(HTMLElement.prototype, {
                createdCallback: {
                    value: function () {
                        var main = doc.querySelector('#game-element');
                        var mainElement = document.importNode(main.content, true);
                        this.appendChild(mainElement);
                    }
                },
                attachedCallback: {
                    value: function () {
                        const gameState = this.querySelector('#game-state');
                        const gameRender = this.querySelector('#game-render');
                        gameRender.style.display = 'none';

                        const game = this;
                        App.state.subscribeState("loading-game-assets", function () {
                            gameState.innerHTML = 'Loading game assets...';
                        });
                        App.state.subscribeState("ready-to-connect", function () {
                            gameState.innerHTML = '';
                        });
                        App.state.subscribeState("running", function () {
                            gameState.style.display = 'none';
                            gameRender.style.display = 'block';
                        });
                        App.state.subscribeState("error", function () {
                            gameState.style.display = 'block';
                            gameRender.style.display = 'none';
                            gameState.innerHTML = 'Server error, refer to logs for more information.'
                        });
                        App.state.subscribeState("disconnected", function () {
                            gameState.style.display = 'block';
                            gameRender.style.display = 'none';
                            gameState.innerHTML = 'Disconnected from the server.'
                        });
                        App.init(gameRender);
                        App.state.subscribe(function (state) {
                            //noinspection JSClosureCompilerSyntax
                            game.dispatchEvent(new Event(state));
                        });

                        StatsStore.updateStatsState.subscribe((function (data) {
                            game.dispatchEvent(new CustomEvent('update-profile-stats', {detail: data}));
                        }));

                        window.addEventListener('mousedown', function (event) {
                            if (event.which && event.which == 1) {
                                Dispatcher.userEventStream.publish('left-click', event);
                            }
                            if (event.which && event.which == 3) {
                                Dispatcher.userEventStream.publish('right-click', event);
                            }
                        });
                    }
                },
                attributeChangedCallback: {
                    value: function (attrName, oldVal, newVal) {
                        if (attrName == 'user') {
                            const url = this.getAttribute("url");
                            App.setUserNick(newVal);
                            App.connect(url);
                        }
                    }
                },
                uiState: {value: UiStateStore},
                publishUiAction: {value: Dispatcher.userEventStream.publish.bind(Dispatcher.userEventStream)},
                backdoor: {value: Backdoor},
                timer: {value: Timer},
                skillByKey: {value: Skills.skill}
            });

            document.registerElement('dzida-game', {
                prototype: GameTag
            });
        });

    })(document.currentScript.ownerDocument);

</script>